<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>BRAND News Sentiment Dashboard</title>
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Papa Parse -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <style>
    .th-sort { cursor:pointer; user-select:none }
    .th-sort .arrow { opacity:.35; margin-left:.25rem }
    .th-sort.active .arrow { opacity:1 }
    .truncate-2 { display:-webkit-box; -webkit-line-clamp:2; -webkit-box-orient:vertical; overflow:hidden }
    #trendWrap { height:22rem; }
  </style>
</head>
<body class="bg-slate-50 text-slate-900">
  <div class="max-w-7xl mx-auto p-6">
    <header class="mb-6">
      <h1 class="text-3xl font-bold">BRAND News Sentiment Dashboard</h1>
      <p class="text-sm text-slate-600">
        Data sources: <code>data/daily_counts.csv</code>, <code>data/serps/brand_serps.csv</code>, <code>data/articles/YYYY-MM-DD.csv</code>, <code>data/roster.csv</code>.
      </p>
    </header>

    <!-- Controls -->
    <section class="mb-4 grid gap-3 md:grid-cols-3">
      <div>
        <label class="block text-sm font-medium mb-1">Pick date</label>
        <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
      </div>
      <div>
        <label class="block text-sm font-medium mb-1">Filter brands</label>
        <input id="filterInput" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2"/>
      </div>
      <div class="flex items-end gap-2">
        <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
      </div>
    </section>

    <!-- Trend -->
    <section class="mb-6 p-4 border rounded-xl bg-white">
      <div class="flex items-center justify-between mb-2">
        <h2 class="text-lg font-semibold">Sentiment trend</h2>
        <div class="text-xs text-slate-500 space-x-2">
          <span id="trendInfo"></span><span id="trendRange"></span>
          <button id="trendPrev" class="px-2 py-1 border rounded disabled:opacity-40" title="Older">←</button>
          <button id="trendNext" class="px-2 py-1 border rounded disabled:opacity-40" title="Newer">→</button>
        </div>
      </div>
      <p id="trendHint" class="text-sm text-slate-500 mb-2 hidden">
        Select exactly <span class="font-semibold">1</span> brand to display its trend.  
        With none selected, we show the <span class="font-semibold">index average</span>.
      </p>
      <div id="trendWrap"><canvas id="trendChart"></canvas></div>
    </section>

    <!-- Table -->
    <section class="overflow-x-auto">
      <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border">
        <thead class="bg-slate-100">
          <tr>
            <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
            <th class="p-3 text-left">Brand</th>
            <th class="p-3 text-left">Theme</th>
            <th class="p-3 text-left th-sort" data-sort="negNewsPct">
              Negative News (%) <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="negSerpPct">
              Negative SERP (%) <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="controlPct">
              SERP Control (%) <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left th-sort" data-sort="risk">
              Risk <span class="arrow">▾</span>
            </th>
            <th class="p-3 text-left">Headlines</th>
            <th class="p-3 text-left">SERP</th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>

      <!-- Pagination -->
      <div class="flex items-center justify-between mt-3">
        <p id="status" class="text-xs text-slate-500"></p>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="px-3 py-1 border rounded disabled:opacity-40">Prev</button>
          <span id="pageInfo" class="text-xs text-slate-600"></span>
          <button id="nextPage" class="px-3 py-1 border rounded disabled:opacity-40">Next</button>
        </div>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
        <div class="flex items-center justify-between p-4 border-b">
          <div>
            <h3 id="modalTitle" class="text-xl font-bold">Modal</h3>
            <p id="modalSubtitle" class="text-sm text-slate-600"></p>
          </div>
          <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
        </div>
        <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
          <p class="text-sm text-slate-500">Loading…</p>
        </div>
      </div>
    </div>
  </div>

<script>
(function(){
  // ===== Paths =====
  const CSV_COUNTS   = 'data/daily_counts.csv';
  const CSV_ARTICLES = (date) => `data/articles/${date}.csv`;
  const CSV_SERPS    = 'data/serps/brand_serps.csv';
  const CSV_ROSTER   = 'data/roster.csv';

  // ===== DOM =====
  const dateSelect   = document.getElementById('dateSelect');
  const filterInput  = document.getElementById('filterInput');
  const refreshBtn   = document.getElementById('refreshBtn');
  const selectAll    = document.getElementById('selectAll');
  const tbody        = document.getElementById('tableBody');
  const statusEl     = document.getElementById('status');
  const pageInfoEl   = document.getElementById('pageInfo');
  const prevPageBtn  = document.getElementById('prevPage');
  const nextPageBtn  = document.getElementById('nextPage');

  const trendCanvas  = document.getElementById('trendChart');
  const trendInfo    = document.getElementById('trendInfo');
  const trendRange   = document.getElementById('trendRange');
  const trendPrev    = document.getElementById('trendPrev');
  const trendNext    = document.getElementById('trendNext');
  const trendHint    = document.getElementById('trendHint');
  let trendChart     = null;

  const modalBackdrop= document.getElementById('modalBackdrop');
  const modalTitle   = document.getElementById('modalTitle');
  const modalSubtitle= document.getElementById('modalSubtitle');
  const modalBody    = document.getElementById('modalBody');
  const modalClose   = document.getElementById('modalClose');

  // ===== State =====
  const PAGE_SIZE = 25;
  let allCountsRows = [];
  let allDates = [];
  let currentDate = null;

  let roster = [];                // [{company, root, stock, sector, ceo}]
  let byCompany = new Map();      // keyCompany -> roster row
  let isControlledLink = ()=>false;

  let serpAgg = new Map();        // brandKey -> {total,neg,ctrl}
  const articlesCache = {};       // date -> article rows
  const themesByDate = {};        // date -> brandKey -> theme

  let selected = new Set();
  let sortKey = 'negNewsPct';
  let sortDir = 'desc';
  let filterText = '';
  let pageIndex = 0;

  // ===== Utils =====
  function normalizeKeys(row){
    const out={}; for(const k in row){ out[String(k||'').replace(/^\ufeff/,'').trim().toLowerCase()] = row[k]; }
    return out;
  }
  function keyCompany(s){ return String(s||'').trim().toLowerCase(); }
  function toNum(x){ x=Number(x||0); return isFinite(x)?x:0; }
  function fmtPct(n){ n=Number(n||0); if(!isFinite(n)) n=0; return n.toFixed(0)+'%'; }
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }

  // ===== Roster =====
  // Add this near the top-level (above loadRoster or inside it before assigning isControlledLink)
const CONTROLLED_HOST_SUFFIXES = [
  // Social & app stores to always treat as controlled
  'linkedin.com',
  'facebook.com',
  'x.com',          // X (formerly Twitter)
  'twitter.com',    // (keep legacy just in case)
  'instagram.com',
  'apps.apple.com', // Apple App Store
  'play.google.com' // Google Play
];

function hostMatchesSuffix(host, suffix) {
  return host === suffix || host.endsWith('.' + suffix);
}

  async function loadRoster(){
    const txt = await (await fetch(CSV_ROSTER+'?_='+Date.now(), {cache:'no-store'})).text();
    const {data} = Papa.parse(txt, {header:true});
    roster = (data||[]).map(r=>({
      company:(r.Company||'').trim(),
      root:(r.Website||'').trim().toLowerCase(),
      stock:(r.Stock||'').trim(),
      sector:(r.Sector||'').trim(),
      ceo:(r.CEO||'').trim()
    })).filter(r=>r.company);
    byCompany = new Map(roster.map(r=>[keyCompany(r.company), r]));
    isControlledLink = (url)=>{
      try{
        const d = new URL(url).hostname.toLowerCase();
        for(const r of roster){
          if(!r.root) continue;
          if(d===r.root) return true;
          if(d.endsWith('.'+r.root)) return true;
        }
      }catch{}
      return false;
    };
  }

  // ===== SERPs (aggregate by brand) =====
  async function loadSerps(){
    serpAgg = new Map();
    const txt = await (await fetch(CSV_SERPS+'?_='+Date.now(), {cache:'no-store'})).text();
    const {data} = Papa.parse(txt, {header:true});
    for(const raw of (data||[])){
      const r = normalizeKeys(raw);
      const brand = (r.brand||r.company||'').trim();
      if(!brand) continue;
      const url = (r.link||r.url||'').trim();
      const sentiment = (r.sentiment||'').trim().toLowerCase();
      let control = (String(r.control||'').trim().toLowerCase()==='true');
      if(!control && url) control = isControlledLink(url);

      const k = keyCompany(brand);
      const obj = serpAgg.get(k) || {total:0,neg:0,ctrl:0};
      obj.total++;
      if(sentiment==='negative') obj.neg++;
      if(control) obj.ctrl++;
      serpAgg.set(k, obj);
    }
  }

  // ===== Counts (news) =====
  async function loadCounts(){
    const txt = await (await fetch(CSV_COUNTS+'?_='+Date.now(), {cache:'no-store'})).text();
    const {data} = Papa.parse(txt, {header:true, dynamicTyping:true});
    const rows = (data||[]).map(normalizeKeys).filter(r=>r.date && r.brand);
    allCountsRows = rows.map(r=>({
      date:String(r.date),
      brand:String(r.brand),
      total:toNum(r.total),
      pos:toNum(r.positive),
      neu:toNum(r.neutral),
      neg:toNum(r.negative),
      theme:String(r.theme||'')
    }));
    allDates = Array.from(new Set(allCountsRows.map(r=>r.date))).sort();
    currentDate = allDates[allDates.length-1] || null;
  }

  // ===== Articles (for themes + headlines drilldown) =====
  async function loadArticlesForDate(date){
    if(articlesCache[date]) return articlesCache[date];
    try{
      const txt = await (await fetch(CSV_ARTICLES(date)+'?_='+Date.now(), {cache:'no-store'})).text();
      const {data} = Papa.parse(txt, {header:true});
      const rows = (data||[]).map(normalizeKeys).map(r=>({
        brand:(r.brand||r.brand_name||r.company||'').trim(),
        title:(r.title||r.headline||'').trim(),
        url:(r.url||r.link||'').trim(),
        domain:(r.domain||''),
        sentiment:(r.sentiment||'neutral').trim().toLowerCase(),
        published:String(r.published||r.date||'')
      }));
      articlesCache[date]=rows;
    }catch{ articlesCache[date]=[]; }
    return articlesCache[date];
  }

  // ===== Themes =====
  const STOP = new Set(`a an the and or but of for to in on at by with from as about after over under into across amid amidst per
    this that these those it its their his her they we you our your i
    is are was were be been being has have had do does did will would should can could may might must
    new update updates report reports reported says say said see sees seen
    market stock shares price prices wins loss losses gain gains amid amidst news today latest analyst analysts rating cut cuts
    quarter q1 q2 q3 q4 year years 2023 2024 2025 inc corp co ltd plc ceo company board group
  `.split(/\s+/).filter(Boolean));
  function cleanHeadline(t){ const i=t.lastIndexOf(' - '); if(i>10) t=t.slice(0,i); return t; }
  function tokens(s){ return s.toLowerCase().replace(/[^\p{L}\p{N}\s'-]+/gu,' ').split(/\s+/).filter(w=>w&&!STOP.has(w)); }
  function topTheme(headlines){
    const grams=new Map(); const add=g=>grams.set(g,(grams.get(g)||0)+1);
    for(const h of headlines){
      const t=tokens(cleanHeadline(h));
      for(let n=3;n>=2;n--) for(let i=0;i<=t.length-n;i++) add(t.slice(i,i+n).join(' '));
      for(const w of t) add(w);
    }
    if(!grams.size) return 'None';
    let cand=[...grams.entries()].filter(([g,c])=>g.split(' ').length>=2 && c>=2).sort((a,b)=>b[1]-a[1]);
    if(cand.length) return cand[0][0].split(' ').slice(0,5).join(' ');
    cand=[...grams.entries()].filter(([g,c])=>g.split(' ').length===2 && c>=1).sort((a,b)=>b[1]-a[1]);
    if(cand.length) return cand[0][0];
    const uni=[...grams.entries()].filter(([g])=>g.split(' ').length===1).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([g])=>g);
    return uni.length? uni.join(' ') : 'None';
  }
  async function computeThemesForDate(date){
    if(themesByDate[date]) return themesByDate[date];
    const rows=await loadArticlesForDate(date);
    const by=new Map();
    for(const r of rows){
      if(r.sentiment!=='negative') continue;
      const k=keyCompany(r.brand); if(!k) continue;
      const arr=by.get(k)||[]; if(r.title) arr.push(r.title); by.set(k,arr);
    }
    const map={}; for(const [k,list] of by) map[k]=topTheme(list);
    themesByDate[date]=map; return map;
  }

  // ===== Build table rows =====
  function enrichRowsForDate(date){
    const rows = allCountsRows.filter(r=>r.date===date);
    return rows.map(r=>{
      const k = keyCompany(r.brand);
      const serp = serpAgg.get(k) || {total:0,neg:0,ctrl:0};
      const negNewsPct = r.total ? (r.neg/r.total*100) : 0;
      const negSerpPct = serp.total ? (serp.neg/serp.total*100) : 0;
      const controlPct = serp.total ? (serp.ctrl/serp.total*100) : 0;
      const risk = (negSerpPct>0) ? 'High' : ((negSerpPct===0 && controlPct<35) ? 'Medium' : 'Low');
      const themeMap = themesByDate[date] || {};
      const theme = themeMap[k] || r.theme || 'None';
      return {
        date:r.date, brand:r.brand,
        total:r.total,pos:r.pos,neu:r.neu,neg:r.neg,
        negNewsPct, negSerpPct, controlPct, risk,
        serpTotal:serp.total,
        theme
      };
    });
  }
  function sortRows(rows){
    const dir=(sortDir==='asc')?1:-1;
    return rows.sort((a,b)=>{
      if(sortKey==='risk'){ const rank={High:3,Medium:2,Low:1}; return (rank[a.risk]-rank[b.risk])*dir; }
      return ((a[sortKey]||0) - (b[sortKey]||0))*dir;
    });
  }
  function applyFilter(rows){
    if(!filterText) return rows;
    const q=filterText.toLowerCase();
    return rows.filter(r=> r.brand.toLowerCase().includes(q));
  }
  function paginate(rows){
    const start=pageIndex*PAGE_SIZE; return rows.slice(start,start+PAGE_SIZE);
  }

  function renderTable(){
    let rows = enrichRowsForDate(currentDate);
    rows = applyFilter(rows);
    const totalCount = rows.length;
    rows = sortRows(rows);
    const pageRows = paginate(rows);

    document.querySelectorAll('.th-sort').forEach(th=>{
      th.classList.remove('active'); th.querySelector('.arrow').textContent='▾';
      if(th.dataset.sort===sortKey){ th.classList.add('active'); th.querySelector('.arrow').textContent=(sortDir==='asc'?'▴':'▾'); }
    });

    tbody.innerHTML = pageRows.map(r=>{
      const checked = selected.has(r.brand) ? 'checked':'';
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-brand="${escapeHtml(r.brand)}" ${checked}></td>
        <td class="p-3 font-medium"><button class="underline" data-view-news="${escapeHtml(r.brand)}">${escapeHtml(r.brand)}</button></td>
        <td class="p-3 text-slate-700 truncate-2" title="${escapeHtml(r.theme)}">${escapeHtml(r.theme)}</td>
        <td class="p-3" title="${r.neg}/${r.total}">${fmtPct(r.negNewsPct)}</td>
        <td class="p-3">${ r.serpTotal ? fmtPct(r.negSerpPct) : '—' }</td>
        <td class="p-3">${ r.serpTotal ? fmtPct(r.controlPct) : '—' }</td>
        <td class="p-3">${r.risk}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-view-news="${escapeHtml(r.brand)}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded-lg" data-view-serp="${escapeHtml(r.brand)}">View</button></td>
      </tr>`;
    }).join('\n');

    statusEl.textContent = `${totalCount} brands on ${currentDate}. Page ${pageIndex+1} of ${Math.max(1, Math.ceil(totalCount/PAGE_SIZE))}`;
    pageInfoEl.textContent = `Page ${pageIndex+1}`;
    prevPageBtn.disabled = pageIndex===0;
    nextPageBtn.disabled = (pageIndex+1) >= Math.ceil(totalCount/PAGE_SIZE);

    attachRowHandlers();
    updateTrend();
  }

  function attachRowHandlers(){
    tbody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const brand = cb.getAttribute('data-brand');
        if(cb.checked) selected.add(brand); else selected.delete(brand);
        updateTrend();
      });
    });
    tbody.querySelectorAll('[data-view-news]').forEach(btn=>{
      btn.addEventListener('click', ()=> showNews(btn.getAttribute('data-view-news')));
    });
    tbody.querySelectorAll('[data-view-serp]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSerp(btn.getAttribute('data-view-serp')));
    });
  }

  // ===== Trend (index avg when none selected) =====
  function seriesForBrand(brand){
    const map=new Map();
    for(const r of allCountsRows){ if(r.brand===brand) map.set(r.date,r); }
    const pos=[],neu=[],neg=[],dates=[...allDates];
    for(const d of dates){
      const r=map.get(d)||{total:0,pos:0,neu:0,neg:0};
      const t=r.total||0;
      pos.push(t? +(r.pos/t*100).toFixed(1):0);
      neu.push(t? +(r.neu/t*100).toFixed(1):0);
      neg.push(t? +(r.neg/t*100).toFixed(1):0);
    }
    return {dates,pos,neu,neg};
  }
  function seriesForIndexAverage(){
    const pos=[],neu=[],neg=[];
    for(const d of allDates){
      const rows=allCountsRows.filter(r=>r.date===d);
      const T=rows.reduce((s,r)=>s+(r.total||0),0);
      const P=rows.reduce((s,r)=>s+(r.pos||0),0);
      const N=rows.reduce((s,r)=>s+(r.neu||0),0);
      const G=rows.reduce((s,r)=>s+(r.neg||0),0);
      pos.push(T? +(P/T*100).toFixed(1):0);
      neu.push(T? +(N/T*100).toFixed(1):0);
      neg.push(T? +(G/T*100).toFixed(1):0);
    }
    return {dates:[...allDates],pos,neu,neg};
  }
  const TREND_WINDOW=30; let trendPage=0;
  function updateTrend(){
    let mode='index', target=null;
    if(selected.size===1){ mode='brand'; target=[...selected][0]; }

    const full = (mode==='brand') ? seriesForBrand(target) : seriesForIndexAverage();
    trendHint.classList.toggle('hidden', mode==='brand');

    const total=full.dates.length, W=TREND_WINDOW;
    const maxPage=Math.max(0,Math.ceil(total/W)-1);
    if(trendPage>maxPage) trendPage=maxPage;
    const end=Math.max(0,total-W*trendPage);
    const start=Math.max(0,end-W);

    const labels=full.dates.slice(start,end);
    const pos=full.pos.slice(start,end);
    const neu=full.neu.slice(start,end);
    const neg=full.neg.slice(start,end);

    trendInfo.textContent = (mode==='brand') ? `BRAND: ${target}` : `INDEX AVERAGE`;
    trendRange.textContent = labels.length? ` | DATE: ${labels[0]} → ${labels[labels.length-1]}` : '';

    const data={ labels, datasets:[
      {label:'Positive', data:pos, backgroundColor:'#98c15b', stack:'s'},
      {label:'Neutral',  data:neu, backgroundColor:'#dae5e6', stack:'s'},
      {label:'Negative', data:neg, backgroundColor:'#ffb199', stack:'s'},
    ]};
    const options={ responsive:true, maintainAspectRatio:false,
      plugins:{ legend:{position:'top'}, tooltip:{ callbacks:{ label:(c)=>`${c.dataset.label}: ${c.parsed.y}%` } } },
      scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true, ticks:{callback:v=>v+'%'}} }
    };
    if(trendChart) trendChart.destroy();
    trendChart=new Chart(trendCanvas.getContext('2d'),{type:'bar',data,options});
  }
  trendPrev.addEventListener('click',()=>{ trendPage+=1; updateTrend(); });
  trendNext.addEventListener('click',()=>{ trendPage=Math.max(0,trendPage-1); updateTrend(); });

  // ===== Drilldowns =====
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', (e)=>{ if(e.target===modalBackdrop) closeModal(); });
  window.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeModal(); });

  async function showNews(brand){
    modalTitle.textContent = `${brand} — Headlines`;
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const all = await loadArticlesForDate(currentDate);
    const key = keyCompany(brand);
    const rows = all.filter(r => keyCompany(r.brand) === key);
    rows.sort((a,b)=>{
      const order=x=>x.sentiment==='negative'?2:(x.sentiment==='neutral'?1:0);
      const d=order(b)-order(a); if(d) return d;
      return (Date.parse(b.published||'')||0)-(Date.parse(a.published||'')||0);
    });

    if(!rows.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No articles found for ${escapeHtml(brand)} on ${currentDate}.</p>`;
      return;
    }
    modalBody.innerHTML = rows.map(r=>{
      return `<div class="p-3 border rounded-xl hover:bg-slate-50 mb-2">
        <div class="flex items-center justify-between gap-3">
          <div class="text-xs text-slate-500">${escapeHtml(r.domain||'')}</div>
          <div class="text-xs ${r.sentiment==='negative'?'text-rose-700 bg-rose-100':(r.sentiment==='positive'?'text-emerald-700 bg-emerald-100':'text-slate-700 bg-slate-100')} px-2 py-0.5 rounded-full">${escapeHtml(r.sentiment)}</div>
        </div>
        <a class="block mt-1 underline font-medium" target="_blank" rel="noopener" href="${r.url}">${escapeHtml(r.title)}</a>
        ${r.published? `<div class="text-xs text-slate-500 mt-1">${escapeHtml(r.published)}</div>`:''}
      </div>`;
    }).join('\n');
  }

  async function showSerp(brand){
    modalTitle.textContent = `${brand} — SERP`;
    modalSubtitle.textContent = '';
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const txt = await (await fetch(CSV_SERPS+'?_='+Date.now(), {cache:'no-store'})).text();
    const {data} = Papa.parse(txt, {header:true});
    const key = keyCompany(brand);
    const list = (data||[]).map(normalizeKeys).filter(r=> keyCompany(r.brand||r.company)===key);

    if(!list.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No SERP rows found for ${escapeHtml(brand)}.</p>`;
      return;
    }

    modalBody.innerHTML = list.map(r=>{
      const url = r.link || r.url || '';
      const sentiment = (r.sentiment||'').toLowerCase();
      const ctrl = String(r.control||'').toLowerCase()==='true' || (url && isControlledLink(url));
      let domain=''; try{ domain=new URL(url).hostname; }catch{}
      return `<div class="p-3 border rounded-xl hover:bg-slate-50 mb-2">
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-500">${escapeHtml(domain)}</div>
          <div class="flex gap-2">
            <span class="text-xs ${ctrl?'text-emerald-700 bg-emerald-100':'text-rose-700 bg-rose-100'} px-2 py-0.5 rounded-full">${ctrl?'controlled':'uncontrolled'}</span>
            <span class="text-xs ${sentiment==='negative'?'text-rose-700 bg-rose-100':(sentiment==='positive'?'text-emerald-700 bg-emerald-100':'text-slate-700 bg-slate-100')} px-2 py-0.5 rounded-full">${escapeHtml(sentiment||'neutral')}</span>
          </div>
        </div>
        <a class="block mt-1 underline font-medium" target="_blank" rel="noopener" href="${url}">${escapeHtml(r.title||'View result')}</a>
        ${r.snippet? `<div class="text-xs text-slate-600 mt-1">${escapeHtml(r.snippet)}</div>`:''}
      </div>`;
    }).join('\n');
  }

  // ===== Events =====
  dateSelect.addEventListener('change', async ()=>{
    currentDate = dateSelect.value;
    await computeThemesForDate(currentDate);
    pageIndex=0; renderTable();
  });
  filterInput.addEventListener('input', ()=>{ filterText=filterInput.value||''; pageIndex=0; renderTable(); });
  refreshBtn.addEventListener('click', async ()=>{ await init(); });

  selectAll.addEventListener('change', ()=>{
    if(selectAll.checked){
      tbody.querySelectorAll('input[type="checkbox"]').forEach(cb=>{ cb.checked=true; selected.add(cb.getAttribute('data-brand')); });
    }else{
      selected.clear();
      tbody.querySelectorAll('input[type="checkbox"]').forEach(cb=> cb.checked=false);
    }
    updateTrend();
  });

  prevPageBtn.addEventListener('click', ()=>{ if(pageIndex>0){ pageIndex--; renderTable(); } });
  nextPageBtn.addEventListener('click', ()=>{ pageIndex++; renderTable(); });

  document.querySelectorAll('.th-sort').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.dataset.sort;
      if(sortKey===key){ sortDir=(sortDir==='asc'?'desc':'asc'); }
      else { sortKey=key; sortDir='desc'; }
      pageIndex=0; renderTable();
    });
  });

  // ===== Init =====
  async function init(){
    await loadRoster();
    await Promise.all([loadCounts(), loadSerps()]);
    dateSelect.innerHTML = allDates.map(d=>`<option value="${d}">${d}</option>`).join('');
    if(currentDate) dateSelect.value=currentDate;
    await computeThemesForDate(currentDate);
    selected.clear(); filterText=''; filterInput.value=''; sortKey='negNewsPct'; sortDir='desc'; pageIndex=0;
    renderTable();
  }

  init();
})();
</script>
</body>
</html>
