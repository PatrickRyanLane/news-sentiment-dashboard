<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CEO News Sentiment Dashboard</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<style>
  th.sortable { cursor: pointer; user-select: none; }
  th.sortable .arrow { margin-left: .35rem; font-size: .8em; opacity:.6 }
  th.sortable[data-aria-sort="asc"]  .arrow::after  { content: "▲"; }
  th.sortable[data-aria-sort="desc"] .arrow::after  { content: "▼"; }
</style>
</head>
<body class="bg-slate-50 text-slate-900">
<div class="max-w-7xl mx-auto p-6">
  <header class="mb-6">
    <h1 class="text-3xl font-bold">CEO News Sentiment Dashboard</h1>
    <p class="text-sm text-slate-600">
      Shows the top Fortune 500 CEOs by negative article share for a selected day.
      Data sources: <code>data_ceos/daily_counts.csv</code>, <code>data/serps/ceo_serps.csv</code>, <code>data/ceo_boards.csv</code>.
    </p>
  </header>

  <!-- Controls -->
  <section class="mb-4 grid gap-3 md:grid-cols-3">
    <div>
      <label class="block text-sm font-medium mb-1">Pick date</label>
      <select id="dateSelect" class="w-full border rounded-lg p-2 bg-white"></select>
    </div>
    <div>
      <label class="block text-sm font-medium mb-1">Filter CEOs</label>
      <input id="filterInput" type="text" placeholder="Type to filter…" class="w-full border rounded-lg p-2" />
    </div>
    <div class="flex items-end gap-2">
      <button id="refreshBtn" class="px-3 py-2 rounded-lg bg-slate-900 text-white">Refresh</button>
    </div>
  </section>

  <!-- Trend -->
  <section class="mb-6 p-4 border rounded-xl bg-white">
    <div class="flex items-center justify-between mb-2">
      <h2 class="text-lg font-semibold">Sentiment trend</h2>
      <div class="text-xs text-slate-500" id="trendCaption"></div>
    </div>
    <div class="h-64"><canvas id="trendChart"></canvas></div>
  </section>

  <!-- Table -->
  <section class="overflow-x-auto">
    <table class="min-w-full text-sm bg-white rounded-xl overflow-hidden border" id="mainTable">
      <thead class="bg-slate-100">
        <tr>
          <th class="p-3 text-left w-10"><input type="checkbox" id="selectAll"></th>
          <th class="p-3 text-left sortable" data-sort="ceo">CEO <span class="arrow"></span></th>
          <th class="p-3 text-left">Company</th>
          <th class="p-3 text-left">Theme</th>
          <th class="p-3 text-left sortable" data-sort="negNews">Negative News (%) <span class="arrow"></span></th>
          <th class="p-3 text-left sortable" data-sort="negSerp">Negative SERP (%) <span class="arrow"></span></th>
          <th class="p-3 text-left sortable" data-sort="ctrl">SERP Control (%) <span class="arrow"></span></th>
          <th class="p-3 text-left sortable" data-sort="risk">Risk <span class="arrow"></span></th>
          <th class="p-3 text-left">Headlines</th>
          <th class="p-3 text-left">SERP</th>
          <th class="p-3 text-left">Boards</th>
        </tr>
      </thead>
      <tbody id="tableBody"></tbody>
    </table>

    <div class="flex items-center justify-between mt-3">
      <div class="text-xs text-slate-500" id="status"></div>
      <div class="flex items-center gap-2">
        <button id="prevPage" class="px-2 py-1 border rounded disabled:opacity-40">Prev</button>
        <span id="pageInfo" class="text-xs text-slate-600"></span>
        <button id="nextPage" class="px-2 py-1 border rounded disabled:opacity-40">Next</button>
      </div>
    </div>
  </section>
</div>

<!-- Modal -->
<div id="modalBackdrop" class="fixed inset-0 z-50 hidden">
  <div class="absolute inset-0 bg-black/40"></div>
  <div class="absolute inset-0 flex items-center justify-center p-4">
    <div class="w-full max-w-3xl bg-white rounded-2xl shadow-xl overflow-hidden">
      <div class="flex items-center justify-between p-4 border-b">
        <div>
          <h3 id="modalTitle" class="text-xl font-bold">Details</h3>
          <p id="modalSubtitle" class="text-sm text-slate-600"></p>
        </div>
        <button id="modalClose" class="px-3 py-1.5 rounded-lg border">Close</button>
      </div>
      <div id="modalBody" class="max-h-[70vh] overflow-y-auto p-4">
        <p class="text-sm text-slate-500">Loading…</p>
      </div>
    </div>
  </div>
</div>

<script>
(() => {
  // ---------------- Config / Paths ----------------
  const CSV_COUNTS   = 'data_ceos/daily_counts.csv';
  const CSV_ARTICLES = (date) => `data_ceos/articles/${date}.csv`;
  const CSV_SERPS    = 'data/serps/ceo_serps.csv';
  const CSV_BOARDS   = 'data/ceo_boards.csv';        // FIXED: boards live in data/, not data_ceos/
  const PAGE_SIZE    = 25;

  // ---------------- Elements ----------------
  const dateSelect   = document.getElementById('dateSelect');
  const filterInput  = document.getElementById('filterInput');
  const refreshBtn   = document.getElementById('refreshBtn');
  const selectAll    = document.getElementById('selectAll');
  const tableBody    = document.getElementById('tableBody');
  const statusEl     = document.getElementById('status');
  const prevPageBtn  = document.getElementById('prevPage');
  const nextPageBtn  = document.getElementById('nextPage');
  const pageInfo     = document.getElementById('pageInfo');
  const trendCaption = document.getElementById('trendCaption');
  const trendCanvas  = document.getElementById('trendChart');

  const modalBackdrop = document.getElementById('modalBackdrop');
  const modalTitle    = document.getElementById('modalTitle');
  const modalSubtitle = document.getElementById('modalSubtitle');
  const modalBody     = document.getElementById('modalBody');
  const modalClose    = document.getElementById('modalClose');

  // ---------------- State ----------------
  let allRows = [];     // every row from counts csv (all dates)
  let currentDate = null;
  let working = [];     // filtered and enriched rows (current date + filter)
  let selected = new Set(); // selected CEOs (for trend)
  let trendChart = null;

  // pagination
  let currentPage = 1;
  let totalPages  = 1;

  // sorting
  let sortKey = 'negNews';  // negNews | negSerp | ctrl | risk | ceo
  let sortDir = 'desc';     // asc | desc

  // caches
  const articlesCache = Object.create(null); // {date: [rows]}
  let   serpsLoaded = false;
  let   boardsLoaded = false;
  const serpByCeo = new Map();   // ceoLower -> rows
  const boardsByCeo = new Map(); // ceoLower -> rows
  const serpAggCache = Object.create(null); // by date: ceo -> {negPct, ctrlPct}

  // ---------------- Utils ----------------
  function escapeHtml(s){ return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;'); }
  function fmtPctNum(n){ return Math.round((Number(n)||0)*10)/10; }
  function fmtPct(n){ return fmtPctNum(n).toString().replace(/\.0$/,'') + '%'; }
  function sortRiskVal(r){ return r==='High'?3 : r==='Medium'?2 : 1; }

  function normalizeRowKeys(row){
    const out = {};
    for(const k in row){
      const nk = String(k||'').replace(/^\ufeff/,'').trim().toLowerCase();
      out[nk] = row[k];
    }
    return out;
  }

  function stripPublicationTail(t){ const i = t.lastIndexOf(' - '); return i>0? t.slice(0,i) : t; }

  // Robust control parser: handles boolean-ish and labels like "controlled"/"uncontrolled"
  function parseControl(v){
    if (typeof v === 'boolean') return v;
    const s = String(v||'').trim().toLowerCase();
    if (!s) return false;
    if (s==='true' || s==='t' || s==='1' || s==='yes' || s==='y') return true;
    if (s==='false' || s==='f' || s==='0' || s==='no'  || s==='n') return false;
    if (s.includes('controlled'))   return true;      // "controlled"
    if (s.includes('uncontrolled')) return false;     // "uncontrolled"
    // common synonyms
    if (s.includes('official') || s.includes('owned') || s.includes('site')) return true;
    return false;
  }

  // ---------------- Theme Engine ----------------
  const themesByDate = Object.create(null); // themesByDate[date][ceo] = str
  const STOPWORDS = new Set([
    'the','a','an','and','or','but','of','for','to','in','on','at','by','with','from','as','about','after','over','under','into','across','per',
    'this','that','these','those','it','its','their','his','her','they','we','you','our','your',
    'is','are','was','were','be','been','being','has','have','had','do','does','did','will','would','should','can','could','may','might','must',
    'news','today','latest','update','updates','report','reports','reported','says','say','said','see','sees','seen','watch',
    'market','stock','shares','price','prices','quarter','q1','q2','q3','q4','year','yrs','vs','inc','corp','co','ltd','plc','ceo'
  ]);
  const NGRAM_MAX=4, MIN_PHRASE_COUNT=2, MAX_THEME_WORDS=5;
  function tok(s){ return s.toLowerCase().replace(/[\u2019\u2018']/g,'').replace(/[^a-z0-9]+/g,' ').trim().split(/\s+/).filter(Boolean); }
  function removeNameCompany(tokens, ceo, company){
    const ban = new Set([...STOPWORDS]);
    tok(ceo||'').forEach(w=>ban.add(w)); tok(company||'').forEach(w=>ban.add(w));
    return tokens.filter(t=>!ban.has(t)&&t.length>1);
  }
  function ngr(tokens,n){ const out=[]; for(let i=0;i<=tokens.length-n;i++) out.push(tokens.slice(i,i+n).join(' ')); return out; }
  function countMap(items){ const m=new Map(); items.forEach(x=>m.set(x,(m.get(x)||0)+1)); return m; }
  function bestPhrase(titles, ceo, company){
    const bag = new Map(); let any=false;
    for(const raw of titles){
      const tokens = removeNameCompany(tok(stripPublicationTail(raw||'')), ceo, company);
      if(!tokens.length) continue;
      for(let n=Math.min(NGRAM_MAX,4); n>=2; n--){
        const cm = countMap(ngr(tokens,n));
        for(const [g,c] of cm){ if(c>=MIN_PHRASE_COUNT){ bag.set(g,(bag.get(g)||0)+c); any=true; } }
      }
      if(!any){
        const cm1 = countMap(tokens);
        for(const [w,c] of cm1){ if(c>=MIN_PHRASE_COUNT) bag.set(w,(bag.get(w)||0)+c); }
      }
    }
    if(!bag.size) return '';
    const best=[...bag.entries()].sort((a,b)=>{
      if(b[1]!==a[1]) return b[1]-a[1];
      const al=a[0].split(' ').length, bl=b[0].split(' ').length;
      if(al!==bl) return al-bl;
      return a[0].localeCompare(b[0]);
    })[0][0];
    return best.split(' ').slice(0,MAX_THEME_WORDS).join(' ');
  }
  async function ensureThemesForDate(date){
    if(themesByDate[date]) return;
    const arts = await loadArticlesForDate(date);
    const negByCeo = new Map();
    for(const a of arts){
      if((a.sentiment||'')!=='negative') continue;
      const ceo=(a.ceo||a.brand||'').trim(); if(!ceo) continue;
      if(!negByCeo.has(ceo)) negByCeo.set(ceo, []);
      negByCeo.get(ceo).push(a.title||'');
    }
    const companyByCeo = new Map();
    for(const r of allRows){ if(r.date===date) companyByCeo.set(r.ceo, r.company||''); }
    const out = Object.create(null);
    for(const [ceo, titles] of negByCeo.entries()){
      out[ceo] = bestPhrase(titles, ceo, companyByCeo.get(ceo)||'') || 'None';
    }
    themesByDate[date] = out;
  }
  function themeFor(row){
    const map = themesByDate[currentDate] || {};
    return (map[row.ceo] || row.theme || 'None').trim() || 'None';
  }

  // ---------------- Data Loading ----------------
  async function fetchText(url){
    const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('HTTP '+r.status);
    return await r.text();
  }

  async function loadCountsCsv(){
    const txt = await fetchText(CSV_COUNTS);
    const parsed = Papa.parse(txt,{header:true, dynamicTyping:true});
    const rows = (parsed.data||[]).map(normalizeRowKeys).filter(r=>r.date && (r.ceo || r.brand));
    allRows = rows.map(r=>({
      date: String(r.date),
      ceo:  String(r.ceo || r.brand),
      company: String(r.company || ''),
      total: Number(r.total||0),
      positive: Number(r.positive||0),
      neutral:  Number(r.neutral||0),
      negative: Number(r.negative||0),
      theme: String(r.theme||'').trim()
    }));
    const dates = Array.from(new Set(allRows.map(r=>r.date))).sort();
    dateSelect.innerHTML = dates.map(d=>`<option value="${d}">${d}</option>`).join('');
    currentDate = dates[dates.length-1] || null;
    if(currentDate) dateSelect.value = currentDate;
  }

  async function loadArticlesForDate(date){
    if(articlesCache[date]) return articlesCache[date];
    let rows=[];
    try{
      const txt = await fetchText(CSV_ARTICLES(date));
      const parsed = Papa.parse(txt,{header:true});
      rows = (parsed.data||[]).map(normalizeRowKeys).map(r=>{
        const rawUrl = String(r.url || r.link || '');
        let domain = String(r.domain||'');
        if(!domain && rawUrl){ try{ domain = new URL(rawUrl).hostname; }catch{} }
        return {
          ceo: String(r.ceo || r.brand || '').trim(),
          company: String(r.company || '').trim(),
          title: String(r.title || r.headline || '').trim(),
          url: rawUrl,
          domain,
          sentiment: String(r.sentiment || r.label || 'neutral')
        };
      });
    }catch(e){ console.warn('articles load failed', e); }
    articlesCache[date]=rows; return rows;
  }

  async function loadSerpsOnce(){
    if(serpsLoaded) return;
    try{
      const txt = await fetchText(CSV_SERPS);
      const parsed = Papa.parse(txt,{header:true});
      for(const raw of (parsed.data||[])){
        const r = normalizeRowKeys(raw);
        const ceo = String(r.ceo||'').trim(); if(!ceo) continue;
        const key = ceo.toLowerCase();
        if(!serpByCeo.has(key)) serpByCeo.set(key, []);
        serpByCeo.get(key).push({
          ceo,
          company: String(r.company||'').trim(),
          position: String(r.position||'').trim(),
          title: String(r.title||'').trim(),
          link: String(r.link||'').trim(),
          snippet: String(r.snippet||'').trim(),
          control: parseControl(r.control),
          sentiment: String(r.sentiment||'').trim().toLowerCase()
        });
      }
      serpsLoaded = true;
    }catch(e){ console.warn('serps load failed', e); }
  }

  async function loadBoardsOnce(){
    if(boardsLoaded) return;
    try{
      const txt = await fetchText(CSV_BOARDS);    // FIXED path used here
      const parsed = Papa.parse(txt,{header:true});
      for(const raw of (parsed.data||[])){
        const r = normalizeRowKeys(raw);
        const ceo = String(r.ceo||'').trim(); if(!ceo) continue;
        const key = ceo.toLowerCase();
        if(!boardsByCeo.has(key)) boardsByCeo.set(key, []);
        boardsByCeo.get(key).push({
          url: String(r.url||'').trim(),
          domain: String(r.domain||'').trim()
        });
      }
      boardsLoaded = true;
    }catch(e){ console.warn('boards load failed', e); }
  }

  function serpAggForDate(date){
    if(!serpAggCache[date]) serpAggCache[date] = Object.create(null);
    return serpAggCache[date];
  }

  function computeSerpAggs(date){
    const cache = serpAggForDate(date);
    for(const r of working){
      const key = r.ceo.toLowerCase();
      if(cache[key]) continue;
      const rows = serpByCeo.get(key) || [];
      const n = rows.length || 0;
      const neg = n ? rows.filter(x=>x.sentiment==='negative').length : 0;
      const ctrl = n ? rows.filter(x=>x.control===true).length : 0;   // ensure strict boolean
      cache[key] = {
        negPct: n ? (neg/n*100) : 0,
        ctrlPct: n ? (ctrl/n*100) : 0
      };
    }
  }

  function riskFrom(negSerpPct, ctrlPct){
    if(negSerpPct > 0) return 'High';
    if(ctrlPct < 70)   return 'Medium';
    return 'Low';
  }

  // ---------------- Sorting helpers ----------------
  function setSortIndicators(){
    document.querySelectorAll('th.sortable').forEach(th=>{
      const k = th.getAttribute('data-sort');
      const aria = (k===sortKey) ? sortDir : 'none';
      th.setAttribute('data-aria-sort', aria);
    });
  }

  // ---------------- Render / Compute ----------------
  function applyFilterAndSort(){
    const f = (filterInput.value||'').trim().toLowerCase();
    working = allRows.filter(r=>r.date===currentDate &&
      (!f || r.ceo.toLowerCase().includes(f) || (r.company||'').toLowerCase().includes(f))
    );

    // add serp metrics (from cache)
    const cache = serpAggForDate(currentDate);
    working = working.map(r=>{
      const m = cache[r.ceo.toLowerCase()] || {negPct:0, ctrlPct:0};
      const negNewsPct = r.total ? (r.negative/r.total*100) : 0;
      return {...r, negNews:negNewsPct, negSerp:m.negPct, ctrl:m.ctrlPct, risk:riskFrom(m.negSerp, m.ctrl)};
    });

    // sorting (full dataset)
    const comparators = {
      ceo:      (a,b)=> a.ceo.localeCompare(b.ceo),
      negNews:  (a,b)=> a.negNews - b.negNews,
      negSerp:  (a,b)=> a.negSerp - b.negSerp,
      ctrl:     (a,b)=> a.ctrl - b.ctrl,
      risk:     (a,b)=> sortRiskVal(a.risk) - sortRiskVal(b.risk)
    };
    const cmp = comparators[sortKey] || comparators.negNews;
    working.sort(cmp);
    if(sortDir==='desc') working.reverse();

    // pagination
    totalPages = Math.max(1, Math.ceil(working.length / PAGE_SIZE));
    currentPage = Math.min(currentPage, totalPages);
    setSortIndicators();
  }

  function renderTable(){
    const start = (currentPage-1)*PAGE_SIZE;
    const slice = working.slice(start, start+PAGE_SIZE);

    tableBody.innerHTML = slice.map(r=>{
      return `<tr class="border-t hover:bg-slate-50">
        <td class="p-3"><input type="checkbox" data-ceo="${escapeHtml(r.ceo)}" ${selected.has(r.ceo)?'checked':''}></td>
        <td class="p-3 font-medium"><button class="underline" data-boards="${escapeHtml(r.ceo)}">${escapeHtml(r.ceo)}</button></td>
        <td class="p-3">${escapeHtml(r.company||'')}</td>
        <td class="p-3 text-slate-700">${escapeHtml(themeFor(r))}</td>
        <td class="p-3" title="${r.negative} of ${r.total}">${fmtPct(r.negNews)}</td>
        <td class="p-3">${fmtPct(r.negSerp)}</td>
        <td class="p-3">${fmtPct(r.ctrl)}</td>
        <td class="p-3">${r.risk}</td>
        <td class="p-3"><button class="px-2 py-1 border rounded" data-news="${escapeHtml(r.ceo)}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded" data-serp="${escapeHtml(r.ceo)}">View</button></td>
        <td class="p-3"><button class="px-2 py-1 border rounded" data-boards="${escapeHtml(r.ceo)}">View</button></td>
      </tr>`;
    }).join('');

    // footer UI
    statusEl.textContent = `${working.length} CEOs on ${currentDate}. ${selected.size} selected.`;
    pageInfo.textContent = `Page ${currentPage} / ${totalPages}`;
    prevPageBtn.disabled = currentPage<=1;
    nextPageBtn.disabled = currentPage>=totalPages;

    attachRowHandlers();
    renderTrend();
  }

  function attachRowHandlers(){
    // select checkboxes
    tableBody.querySelectorAll('input[type="checkbox"][data-ceo]').forEach(cb=>{
      cb.addEventListener('change', ()=>{
        const ceo = cb.getAttribute('data-ceo');
        if(cb.checked) selected.add(ceo); else selected.delete(ceo);
        renderTrend();
      });
    });

    // Headlines modal
    tableBody.querySelectorAll('button[data-news]').forEach(btn=>{
      btn.addEventListener('click', ()=> showNews(btn.getAttribute('data-news')));
    });

    // SERP modal
    tableBody.querySelectorAll('button[data-serp]').forEach(btn=>{
      btn.addEventListener('click', ()=> showSerp(btn.getAttribute('data-serp')));
    });

    // Boards modal (CEO name and button both open boards)
    tableBody.querySelectorAll('button[data-boards]').forEach(btn=>{
      btn.addEventListener('click', ()=> showBoards(btn.getAttribute('data-boards')));
    });
  }

  // ---------------- Trend (index avg vs single CEO) ----------------
  function renderTrend(){
    let caption = '';
    let labels = [];
    let pos = [], neu = [], neg = [];

    const allDates = Array.from(new Set(allRows.map(r=>r.date))).sort();
    if(selected.size === 1){
      const ceo = Array.from(selected)[0];
      caption = `CEO: ${ceo}`;
      // single CEO series over all dates
      const map = new Map();
      for(const r of allRows){ if(r.ceo===ceo) map.set(r.date,r); }
      labels = allDates;
      for(const d of labels){
        const r = map.get(d) || {total:0,positive:0,neutral:0,negative:0};
        const t = r.total||0;
        pos.push(t? r.positive/t*100 : 0);
        neu.push(t? r.neutral/t*100 : 0);
        neg.push(t? r.negative/t*100 : 0);
      }
    }else{
      // index average for last ~12 days for legibility
      const N = Math.min(12, allDates.length);
      labels = allDates.slice(-N);
      caption = 'Index average (no CEO selected)';
      for(const d of labels){
        const rows = allRows.filter(r=>r.date===d);
        const sum = rows.reduce((a,r)=>({pos:a.pos+r.positive, neu:a.neu+r.neutral, neg:a.neg+r.negative, tot:a.tot+r.total}), {pos:0,neu:0,neg:0,tot:0});
        const t = sum.tot||0;
        pos.push(t? sum.pos/t*100 : 0);
        neu.push(t? sum.neu/t*100 : 0);
        neg.push(t? sum.neg/t*100 : 0);
      }
    }

    trendCaption.textContent = caption;

    const data = {
      labels,
      datasets: [
        {label:'Positive', data:pos, backgroundColor:'#98c15b', stack:'s'},
        {label:'Neutral',  data:neu, backgroundColor:'#dae5e6', stack:'s'},
        {label:'Negative', data:neg, backgroundColor:'#ffb199', stack:'s'}
      ]
    };
    const options = {
      responsive:true, maintainAspectRatio:false,
      scales:{ x:{stacked:true}, y:{stacked:true, beginAtZero:true, ticks:{callback:v=>v+'%'}} },
      plugins:{ legend:{position:'top'},
        tooltip:{ callbacks:{ label:(ctx)=> `${ctx.dataset.label}: ${fmtPctNum(ctx.parsed.y)}%` } }
      }
    };

    if(trendChart) trendChart.destroy();
    trendChart = new Chart(trendCanvas.getContext('2d'), {type:'bar', data, options});
  }

  // ---------------- Modals ----------------
  function openModal(){ modalBackdrop.classList.remove('hidden'); }
  function closeModal(){ modalBackdrop.classList.add('hidden'); }
  modalClose.addEventListener('click', closeModal);
  modalBackdrop.addEventListener('click', e=>{ if(e.target===modalBackdrop) closeModal(); });
  window.addEventListener('keydown', e=>{ if(e.key==='Escape') closeModal(); });

  async function showNews(ceo){
    modalTitle.textContent = `${ceo} — Headlines`;
    modalSubtitle.textContent = `Date: ${currentDate}`;
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const all = await loadArticlesForDate(currentDate);
    const rows = all.filter(a => (a.ceo||'').trim().toLowerCase() === ceo.toLowerCase());
    rows.sort((a,b)=>{
      const ord = (x)=> x.sentiment==='negative'?2 : x.sentiment==='neutral'?1 : 0;
      return ord(b)-ord(a);
    });
    if(!rows.length){
      modalBody.innerHTML = '<p class="text-sm text-slate-600">No articles found.</p>'; return;
    }
    modalBody.innerHTML = rows.map(r=>`
      <div class="p-3 border rounded-xl mb-3">
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-500">${escapeHtml(r.domain||'')}</div>
          <span class="text-xs px-2 py-0.5 rounded-full ${r.sentiment==='negative'?'bg-rose-100 text-rose-700':(r.sentiment==='positive'?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-700')}">${r.sentiment}</span>
        </div>
        <a class="block mt-1 font-medium underline" href="${r.url}" target="_blank" rel="noopener">${escapeHtml(stripPublicationTail(r.title||''))}</a>
      </div>
    `).join('');
  }

  async function showSerp(ceo){
    await loadSerpsOnce();
    modalTitle.textContent = `${ceo} — SERP`;
    modalSubtitle.textContent = '';
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const rows = serpByCeo.get(ceo.toLowerCase())||[];
    if(!rows.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No SERP rows found for ${escapeHtml(ceo)}.</p>`; return;
    }
    modalBody.innerHTML = rows.map(r=>`
      <div class="p-3 border rounded-xl mb-3">
        <div class="flex items-center justify-between">
          <div class="text-xs text-slate-500">${escapeHtml((() => { try {return new URL(r.link).hostname;} catch {return '';} })())}</div>
          <div class="flex gap-2">
            <span class="text-[11px] px-2 py-0.5 rounded-full ${r.control?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-700'}">${r.control?'controlled':'uncontrolled'}</span>
            <span class="text-[11px] px-2 py-0.5 rounded-full ${r.sentiment==='negative'?'bg-rose-100 text-rose-700':(r.sentiment==='positive'?'bg-emerald-100 text-emerald-700':'bg-slate-100 text-slate-700')}">${r.sentiment||'neutral'}</span>
          </div>
        </div>
        <a class="block mt-1 font-medium underline" href="${r.link}" target="_blank" rel="noopener">${escapeHtml(r.title||'(no title)')}</a>
        ${r.snippet? `<div class="text-xs text-slate-600 mt-1">${escapeHtml(r.snippet)}</div>`:''}
      </div>
    `).join('');
  }

  async function showBoards(ceo){
    await loadBoardsOnce();
    modalTitle.textContent = `${ceo} — Active Boards`;
    modalSubtitle.textContent = '';
    modalBody.innerHTML = '<p class="text-sm text-slate-500">Loading…</p>';
    openModal();

    const rows = boardsByCeo.get(ceo.toLowerCase())||[];
    if(!rows.length){
      modalBody.innerHTML = `<p class="text-sm text-slate-600">No board memberships found for ${escapeHtml(ceo)}.</p>`; return;
    }
    modalBody.innerHTML = rows.map(r=>{
      const domain = r.domain || (()=>{
        try{ return new URL(r.url).hostname; }catch{ return ''; }
      })();
      return `
      <div class="p-3 border rounded-xl mb-3">
        <div class="text-sm font-semibold">${escapeHtml(domain)}</div>
        <a class="block mt-1 text-sm underline" href="${r.url}" target="_blank" rel="noopener">${escapeHtml(r.url)}</a>
      </div>`;
    }).join('');
  }

  // ---------------- Events / Init ----------------
  document.querySelectorAll('th.sortable').forEach(th=>{
    th.addEventListener('click', ()=>{
      const key = th.getAttribute('data-sort');
      if(sortKey===key){ sortDir = (sortDir==='asc'?'desc':'asc'); } else { sortKey=key; sortDir='desc'; }
      applyFilterAndSort(); renderTable();
    });
  });

  filterInput.addEventListener('input', ()=>{ currentPage=1; applyFilterAndSort(); renderTable(); });

  selectAll.addEventListener('change', ()=>{
    if(selectAll.checked){ working.forEach(r=>selected.add(r.ceo)); }
    else selected.clear();
    renderTrend();
  });

  prevPageBtn.addEventListener('click', ()=>{ if(currentPage>1){ currentPage--; renderTable(); } });
  nextPageBtn.addEventListener('click', ()=>{ if(currentPage<totalPages){ currentPage++; renderTable(); } });

  dateSelect.addEventListener('change', async ()=>{
    currentDate = dateSelect.value;
    currentPage = 1; selected.clear();
    await ensureThemesForDate(currentDate);
    applyFilterAndSort(); computeSerpAggs(currentDate); applyFilterAndSort(); renderTable();
  });

  refreshBtn.addEventListener('click', async ()=>{
    await loadCountsCsv();
    await loadSerpsOnce();
    await loadBoardsOnce();
    await ensureThemesForDate(currentDate);
    serpAggCache[currentDate] = Object.create(null);
    currentPage=1; selected.clear();
    applyFilterAndSort(); computeSerpAggs(currentDate); applyFilterAndSort(); renderTable();
  });

  (async function init(){
    statusEl.textContent = 'Loading…';
    await loadCountsCsv();
    await loadSerpsOnce();
    await loadBoardsOnce();
    await ensureThemesForDate(currentDate);
    applyFilterAndSort(); computeSerpAggs(currentDate); applyFilterAndSort();
    renderTable();
  })();
})();
</script>
</body>
</html>
